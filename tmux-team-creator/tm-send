#!/bin/bash

# tm-send v2 - Robust tmux message sender with session isolation
#
# Features:
# - Auto-detects session from current pane OR project directory
# - Uses tmux @role_name pane options (no static file dependency)
# - Verifies pane exists in correct session before sending
# - Works across multiple projects on same tmux server
#
# Usage: tm-send-v2 ROLE "message"
#        tm-send-v2 -s SESSION ROLE "message"  (explicit session)
#        tm-send-v2 --list                      (list roles in current session)
#
# Examples:
#   tm-send-v2 SM "FE -> SM: Task complete."
#   tm-send-v2 -s quiz_game PO "Message to quiz_game PO"
#   tm-send-v2 --list

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() { echo -e "[tm-send] $1"; }
log_success() { echo -e "[tm-send] ${GREEN}$1${NC}"; }
log_warn() { echo -e "[tm-send] ${YELLOW}$1${NC}"; }
log_error() { echo -e "[tm-send] ${RED}ERROR: $1${NC}" >&2; }

# Show usage
usage() {
    echo "Usage: tm-send-v2 [OPTIONS] [ROLE] \"message\""
    echo ""
    echo "Options:"
    echo "  -s, --session SESSION   Specify target session explicitly"
    echo "  -l, --list              List available roles in detected/specified session"
    echo "  -h, --help              Show this help"
    echo ""
    echo "Arguments:"
    echo "  ROLE      Target role (optional). If omitted or not found, sends to first pane."
    echo "  message   The message to send (required)"
    echo ""
    echo "Session Detection (in order):"
    echo "  1. Explicit -s/--session flag"
    echo "  2. TMUX_SESSION environment variable"
    echo "  3. Current pane's session (if running inside tmux)"
    echo "  4. Project directory structure (docs/tmux/*/PANE_ROLES.md)"
    echo ""
    echo "Examples:"
    echo "  tm-send-v2 SM \"FE -> SM: Task complete.\""
    echo "  tm-send-v2 -s quiz_game PO \"Hello from another project\""
    echo "  tm-send-v2 -s hd-tts \"Message to first pane (no role)\""
    echo "  tm-send-v2 --list"
    exit 0
}

# Detect session from project directory structure
detect_session_from_project() {
    local dir="$PWD"
    while [ "$dir" != "/" ]; do
        # Look for any team directory under docs/tmux/
        for team_dir in "$dir"/docs/tmux/*/; do
            if [ -d "$team_dir" ] && [ -f "${team_dir}PANE_ROLES.md" ]; then
                # Extract session name from path
                local session_name=$(basename "$team_dir")
                # Verify this session actually exists in tmux
                if tmux has-session -t "$session_name" 2>/dev/null; then
                    echo "$session_name"
                    return 0
                fi
            fi
        done
        dir=$(dirname "$dir")
    done
    return 1
}

# Detect session (Layer 1: Context Extraction)
detect_session() {
    local explicit_session="$1"

    # Priority 1: Explicit session flag
    if [ -n "$explicit_session" ]; then
        if tmux has-session -t "$explicit_session" 2>/dev/null; then
            echo "$explicit_session"
            return 0
        else
            log_error "Session '$explicit_session' does not exist"
            return 1
        fi
    fi

    # Priority 2: Environment variable
    if [ -n "$TMUX_SESSION" ]; then
        if tmux has-session -t "$TMUX_SESSION" 2>/dev/null; then
            echo "$TMUX_SESSION"
            return 0
        fi
    fi

    # Priority 3: Current pane's session (if inside tmux)
    if [ -n "$TMUX" ]; then
        local current_session=$(tmux display-message -p '#S' 2>/dev/null)
        if [ -n "$current_session" ]; then
            echo "$current_session"
            return 0
        fi
    fi

    # Priority 4: Project directory structure
    local project_session=$(detect_session_from_project)
    if [ -n "$project_session" ]; then
        echo "$project_session"
        return 0
    fi

    return 1
}

# Find pane by role using tmux @role_name option (Layer 2: Dynamic Lookup)
find_pane_by_role() {
    local session="$1"
    local role="$2"

    # Query tmux directly for pane with matching @role_name
    local pane_id=$(tmux list-panes -t "$session" -F '#{pane_id} #{@role_name}' 2>/dev/null | \
                    awk -v role="$role" '$2 == role {print $1; exit}')

    if [ -n "$pane_id" ]; then
        echo "$pane_id"
        return 0
    fi

    return 1
}

# Get first pane of a session (fallback when no role found)
get_first_pane() {
    local session="$1"
    tmux list-panes -t "$session" -F '#{pane_id}' 2>/dev/null | head -1
}

# List all roles in a session
list_roles() {
    local session="$1"

    echo "Roles in session '$session':"
    echo ""
    tmux list-panes -t "$session" -F '  #{@role_name} -> #{pane_id} (index #{pane_index})' 2>/dev/null | \
        grep -v '^ *->' | sort
    echo ""
}

# Verify pane exists in session (Layer 2: Cross-Boundary Verification)
verify_pane_in_session() {
    local session="$1"
    local pane_id="$2"

    # Check if pane exists in the specific session
    tmux list-panes -t "$session" -F '#{pane_id}' 2>/dev/null | grep -q "^${pane_id}$"
}

# Inject timestamp into message if not present
inject_timestamp() {
    local message="$1"
    local timestamp=$(date +"%H:%M")

    # Check if message already has a timestamp pattern like [HH:MM] or HH:MM
    if echo "$message" | grep -qE '\[[0-9]{2}:[0-9]{2}\]|[0-9]{2}:[0-9]{2}:'; then
        echo "$message"
    else
        # Inject timestamp after role prefix if present (e.g., "PO -> SM:" becomes "PO [HH:MM] -> SM:")
        if echo "$message" | grep -qE '^[A-Z]{2,3} ->'; then
            echo "$message" | sed -E "s/^([A-Z]{2,3}) ->/\1 [$timestamp] ->/"
        else
            echo "$message"
        fi
    fi
}

# Main send function (Layer 3: Delivery with Guards)
send_message() {
    local session="$1"
    local pane_id="$2"
    local message="$3"

    # Use pane_id directly (e.g., %17) - tmux resolves it globally
    # We already verified it belongs to the correct session in verify_pane_in_session()
    local target="$pane_id"

    # Send message with two-enter rule
    tmux send-keys -t "$target" "$message" C-m
    sleep 0.3
    tmux send-keys -t "$target" C-m
}

# ============ MAIN ============

EXPLICIT_SESSION=""
LIST_MODE=false

# Parse options
while [[ $# -gt 0 ]]; do
    case $1 in
        -s|--session)
            EXPLICIT_SESSION="$2"
            shift 2
            ;;
        -l|--list)
            LIST_MODE=true
            shift
            ;;
        -h|--help)
            usage
            ;;
        -*)
            log_error "Unknown option: $1"
            usage
            ;;
        *)
            break
            ;;
    esac
done

# Detect session
SESSION=$(detect_session "$EXPLICIT_SESSION") || {
    log_error "Could not detect session. Use -s SESSION or run from project directory."
    exit 1
}

log_info "Detected session: $SESSION"

# Handle --list mode
if [ "$LIST_MODE" = true ]; then
    list_roles "$SESSION"
    exit 0
fi

# Validate arguments - now supports optional role
if [ $# -lt 1 ]; then
    log_error "Missing arguments"
    echo "Usage: tm-send-v2 [ROLE] \"message\""
    echo "       If ROLE is omitted, sends to first pane of session"
    echo "Use --list to see available roles"
    exit 1
fi

# Determine if we have ROLE + MESSAGE or just MESSAGE
if [ $# -eq 1 ]; then
    # Only message provided, no role - will use first pane
    ROLE=""
    MESSAGE="$1"
elif [ $# -ge 2 ]; then
    ROLE="$1"
    MESSAGE="$2"
fi

# Find target pane
if [ -n "$ROLE" ]; then
    # Try to find pane by role (use || true to prevent set -e from exiting)
    PANE_ID=$(find_pane_by_role "$SESSION" "$ROLE") || true
    if [ -n "$PANE_ID" ]; then
        log_info "Resolved role '$ROLE' to pane: $PANE_ID"
    else
        # Role not found - fallback to first pane
        PANE_ID=$(get_first_pane "$SESSION")
        if [ -n "$PANE_ID" ]; then
            log_warn "Role '$ROLE' not found in session '$SESSION'. Falling back to first pane: $PANE_ID"
        else
            log_error "Session '$SESSION' has no panes"
            exit 1
        fi
    fi
else
    # No role specified - use first pane
    PANE_ID=$(get_first_pane "$SESSION")
    if [ -n "$PANE_ID" ]; then
        log_info "No role specified. Using first pane: $PANE_ID"
    else
        log_error "Session '$SESSION' has no panes"
        exit 1
    fi
fi

# Verify pane exists in correct session (cross-boundary check)
if ! verify_pane_in_session "$SESSION" "$PANE_ID"; then
    log_error "Pane $PANE_ID not found in session '$SESSION' (possible session mismatch)"
    exit 1
fi

log_info "Verified pane $PANE_ID exists in session: $SESSION"

# Inject timestamp if not present
MESSAGE=$(inject_timestamp "$MESSAGE")

# Send message
send_message "$SESSION" "$PANE_ID" "$MESSAGE"

log_success "Message sent to $ROLE ($SESSION:$PANE_ID)"
